/*
Copyright 2015, 2016 OpenMarket Ltd
Copyright 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

$left-gutter: 56px;

.sc_BubbleLayout {
    // ---- Overrides ----

    .mx_RoomView_MessageList {
        padding-bottom: 8px;
        padding-right: 10px;
    }

    .mx_RoomTile {
        .mx_RoomTile_nameContainer {
            .mx_RoomTile_name,
            .mx_RoomTile_messagePreview {
                margin: 2px 2px;
            }
        }
    }

    li > .mx_DateSeparator {
        margin: 7px 0px 1px 0px;
    }

    .mx_LinkPreviewWidget {
        margin-bottom: 0px;
    }

    .mx_EventTile {
        // no reserved space for read receipts required.
        padding-top: 6px;

        &.mx_EventTile_info {
            padding-top: 0px;

            .mx_EventTile_avatar {
                left: $left-gutter;
            }
        }

        > .mx_SenderProfile {
            line-height: $font-17px;
            padding-left: $left-gutter;
            max-width: unset !important;
        }

        > .mx_EventTile_line {
            padding-left: $left-gutter !important;
            border-left: none !important;
            background: transparent !important;
            margin-right: unset;
        }

        > .mx_EventTile_avatar {
            position: absolute;
        }

        .mx_EventTile_line, .mx_EventTile_reply {
            padding-top: 3px;
            padding-bottom: 3px;
            padding-left: $left-gutter;
            line-height: $font-22px;
            min-height: $font-22px;
        }
    }

    .mx_EventTile_line, .mx_EventTile_reply {
        padding-left: $left-gutter;
    }

    .mx_EventTile_info .mx_EventTile_line {
        padding-left: calc($left-gutter + 18px) !important;
        max-width: max-content;

        .mx_MessageActionBar {
            top: -21px; // counteract padding: 24-3
        }
    }

    .mx_SenderProfile_name {
        color: $accent-color !important;
    }

    .mx_EventTile_selected > div > a > .mx_MessageTimestamp {
        left: 0px;
        width: 46px;
    }

    .mx_EventTile_msgOption {
        float: unset;
        text-align: unset;
        position: unset;

        margin-left: 8px;
        margin-right: unset;

        /* Hack to stop the height of this pushing the messages apart.
           Replaces margin-top: -6px. This interacts better with a read
           marker being in between. Content overflows. */
        // SC: Reserve our space
        height: 14px;
        margin-top: 6px;
        margin-bottom: 6px;

        // stop read avatars overflowing
        width: 100%;

        &.sc_readReceipts_empty {
            height: 0;
            margin-top: 0;
            margin-bottom: 0;
        }
    }

    .mx_EventTile_bubbleContainer .mx_EventTile_msgOption {
        grid-column: unset; // show read avatara like always
    }    

    .mx_EventTile_readAvatars {
        // SC-TODO align left below msg area
        //top: 29px;
        top: 0;

        // stop read avatars overflowing
        width: 100%;
        height: 22px;
        overflow-x: scroll;
        overflow-y: hidden;
        z-index: 0; // let message action bar not jump away
    }

    .mx_EventTile_readAvatarRemainder {
        height: 14px;
    }

    .mx_EventTile_content {
        // Handled by bubble
        margin-right: unset;
    }

    // Explicit relationships so that it doesn't apply to nested EventTile components (e.g in Replies)
    .mx_EventTile:hover.mx_EventTile_verified .mx_EventTile_line > a > .mx_MessageTimestamp,
    .mx_EventTile:hover.mx_EventTile_unverified .mx_EventTile_line > a > .mx_MessageTimestamp,
    .mx_EventTile:hover.mx_EventTile_unknown .mx_EventTile_line > a > .mx_MessageTimestamp {
        left: 5px;
    }

    .mx_EventTile_isEditing {
        background-color: transparent;
    }

    .mx_EditMessageComposer {
        margin: 0;
        padding: 0;
    
        .mx_EditMessageComposer_buttons {
            position: unset;
            margin: 0;
            margin-left: auto;
            padding: 0;
            padding-top: 10px;
            max-width: 100%;
            background: transparent;
            flex-wrap: wrap;
    
            .mx_AccessibleButton {
                padding: 5px 0;
                width: 11em;
                max-width: 100%;
            }
        }
    }
    
    .mx_BasicMessageComposer {
        max-width: 100%;
    }

    // blockquote.mx_ReplyThread {
    //     margin-bottom: 10px;
    // }

    .mx_ReplyThread, .mx_ReplyPreview {
        // padding-top: 2px;

        .mx_EventTile_avatar {
            top: 4px !important;
        }

        .mx_MessageTimestamp {
            top: 4px !important;
        }
    }

    .mx_MessageActionBar {
        left: unset;
        right: 0px;
    }

    .mx_MFileBody {
        display: flow-root;
        position: relative;
    }

    .mx_MFileBody_download {
        display: inline;
    }

    .mx_MImageBody {
        margin-right: 0;
        position: relative;

        padding: 1px;
        border-radius: $border-radius-normal;
        background: $message-bubble-background;

        .mx_MFileBody_download {
            display: none;
        }

        .mx_MessageTimestamp {
            visibility: visible !important;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            left: unset;
            right: 0;
            top: unset;
            bottom: 0;
            border-radius: $border-radius-normal 0;
            font-size: 0.85em;
            padding: 6px 9px;
            width: unset;
            line-height: 1;
        }
    }

    .sc_EventTile_media_self {
        .mx_MImageBody {
            background: $message-bubble-background-self;
        }
    }
    
    .sc_EventTile_media_sticker {
        .mx_MImageBody {
            background: transparent;
    
            .mx_MessageTimestamp {
                padding-left: 10px;
                padding-right: 10px;
            }
        }
    }

    .mx_MStickerBody_wrapper {
        padding: 0;
    }

    span.mx_MVideoBody {
        display: block;
        max-width: max-content;
        position: relative;

        video.mx_MVideoBody {
            display: block;
            width: auto;
            max-height: 600px;
        }

        .mx_MFileBody {
            display: flex;
            position: relative;
            justify-content: space-between;
            align-items: center;
        }

        .mx_MFileBody_download {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sc_LinkedTimestamp {
            margin-left: 1rem;

            .mx_MessageTimestamp {
                visibility: visible !important;
                position: unset !important;
                width: unset !important;
                font-size: 0.85em;
                line-height: 1;
            }
        }
    }

    .sc_EventTile_media {
        max-width: 600px;
        position: relative;
        
        // maybe:
        // & + .mx_ReactionsRow {
        //     margin-top: 0;
        //     margin-bottom: 0;
        // }
    }

    .sc_EventTile_media_right {
        margin-left: auto;

        > * {
            margin-left: auto;
        }

        .mx_MImageBody_thumbnail {
            left: unset;
            right: 0;
        }
    }

    .mx_MessageTimestamp {
        position: absolute;
        width: 46px; /* 8 + 30 (avatar) + 8 */
    }

    .mx_ReactionsRow {
        margin-right: -6px;
    }

    a.mx_Pill {
        max-width: 100%;
    }

    // ---- Bubble specific ----

    .sc_EventTile_bubbleContainer {
        > .mx_EventTile_avatar {
            top: 9px;
        }
    }

    .mx_EventTile_e2eIcon {
        display: none !important;
    }

    // .sc_EventTile_bubbleLine {
    //     .mx_EventTile_e2eIcon {
    //         left: 16px;

    //         .sc_EventTile_bubbleTailLeftContainer & {
    //             top: 35px;
    //         }
    //     }
    // }

    .sc_EventTile_bubbleArea {
        // No full width for both-side bubbles only
        width: 84%;
        max-width: 88rem;
        padding: 0px;
        margin-bottom: 0;
    }

    .sc_EventTile_bubbleArea_left {
        margin-left: 0px;
        margin-right: auto;
        text-align: left;
    }

    .sc_EventTile_bubble {
        background-color: $message-bubble-background;
        padding: 7px 10px;
        border-radius: $border-radius-normal;
        //margin: 10px auto;
        max-width: max-content;
        // Min width: respect/"hide" bubble tail
        min-width: 20px;
        position: relative;
        //box-sizing: content-box;
        //display: flex;
        //flex-wrap: wrap;

        // Don't inherit bubbleArea alignment
        text-align: start;

        &.sc_EventTile_bubble_tail::before {
            content: '';
            border: 16px solid transparent;
            border-top-color: $message-bubble-background;
            border-bottom: 0;
            position: absolute;
            top: 0;
        }

        > .mx_SenderProfile {
            // Sender-profile within bubble
            max-width: 100%;
            margin-bottom: 4px;
            display: block;
        }

        .mx_ReplyThread_wrapper {
            margin-top: 3px;
        }

        > *:not(.mx_ReplyThread_wrapper) {
            .markdown-body > blockquote {
                margin-top: 3px !important;
            }

            .sc_LinkedTimestamp {
                float: right;
                display: flex;
                margin-left: 1rem;

                &:dir(rtl) {
                    float: none;
                    margin-left: unset;
                }

                .mx_MessageTimestamp {
                    visibility: visible !important;
                    position: unset !important;
                    width: unset !important;
                    text-align: right !important;
                    margin-left: auto;
                    margin-top: auto;
                    padding-top: 0.4rem;
                    margin-bottom: -0.4rem;
                    font-size: 0.85em;
                }
            }

            &.sc_EventTile_bigContent .sc_LinkedTimestamp {
                height: 57px;
            }

            .mx_MStickerBody_wrapper + .sc_LinkedTimestamp {
                float: unset;
                display: block;
            }
        }
    }

    .sc_EventTile_bubble_left {
        margin-left: 0px;
        margin-right: auto;

        &.sc_EventTile_bubble_tail::before {
            left: -8px;
        }
    }

    .sc_EventTile_bubbleArea_right {
        margin-right: 16px;
        margin-left: auto;
        text-align: right;
    }

    .sc_EventTile_bubble_right {
        margin-right: 0px;
        margin-left: auto;

        &.sc_EventTile_bubble_tail::before {
            right: -8px;
        }
    }
    
    .sc_EventTile_bubble_self {
        background-color: $message-bubble-background-self;

        &.sc_EventTile_bubble_tail::before {
            border-top-color: $message-bubble-background-self;
        }
    }

    .sc_EventTile_bubble_notice {
        opacity: 0.6;
    }
    .mx_MNoticeBody {
        opacity: unset;
    }

    .mx_EventTile_selected {
        .sc_EventTile_bubble {
            background: $message-bubble-background-selected;

            &.sc_EventTile_bubble_tail::before {
                border-top-color: $message-bubble-background-selected;
            }
        }

        .mx_MImageBody_thumbnail_container {
            background: $accent-color;
            border-radius: $border-radius-normal;
        }
        .mx_MImageBody_thumbnail {
            opacity: 0.7;
        }

        .sc_MVideoBody_video_container {
            background: $accent-color;
            border-radius: $border-radius-normal;
            display: block;
        }
        span.mx_MVideoBody video.mx_MVideoBody {
            opacity: 0.7;
        }
    }
}

/* Compact layout overrides */

// .mx_MatrixChat_useCompactLayout {
//     .sc_BubbleLayout {
//         // nothing (yet?)
//         // ToDo: figure out if there is a useful way to make it more compact
//         // maybe reduce text line-height and some paddings and margins
//     }
// }
